上一篇文章介绍了 react 中的主要对象，这篇文章来介绍 react 的主流程。

react 可以主流程可以分为两步，分别是 render 阶段和 commit 阶段；render 阶段的主要工作就是生成 fiber 树，commit 的阶段的主要工作就是将 fiber 树描述的 ui 绘制到宿主环境，本文主要讨论的宿主环境就是浏览器。

# render 阶段

在上一篇文章中我们提到了 ReactDom.createRoot().render()函数开启了 react 的首次渲染，主要是在 render 函数中生成了一个 update 对象，并将 update 对象 enqueue 在 hostRootFiber 的 updateQueue 上，随后调用了 scheduleUpdateOnFiber，scheduleUpdateOnFiber 函数开启了 react 的渲染流程。事实上 react 在后续更新时也是触发同样的流程，即用户交互产生 update 对象，将 update 对象 enqueue 进入 fiber 的 updateQueue，然后在此 fiber 调用 scheduleUpdateOnFiber，开启新一轮的更新。

很明显开启 react 新一轮的更新可能是从任一 fiber 对象上开始的，那么 react 怎么确保能够更新所有的收到了影响的 fiber 呢？事实上 react 每次开启更新都会从 hostRootFiber 对象上开始，所以可以猜测 scheduleUpdateOnFiber 的大体流程：

- 根据 fiber 上的 return 对象一直向上回溯到 hostRootFiber
- 做一些初始化准备工作
- 调用真实的更新函数

```ts
export function scheduleUpdateOnFiber(fiber: FiberNode, lane: Lane) {
	// 调度功能
	const root = markUpdateFromFiberToRoot(fiber);
	markRootUpdated(root, lane);
	ensureRootIsScheduled(root);
}
```
